import React, { useCallback, useState, memo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Upload, Image, Video, X, Check, Loader, AlertCircle, Cloud, AlertTriangle } from 'lucide-react';
import { validateFile, compressImage, generateImageThumbnail, generateVideoThumbnail, extractMetadata, formatFileSize, formatDuration, type MediaMetadata } from '../utils/mediaUtils';
import { uploadToS3, type UploadProgress } from '../utils/s3Upload';
import { testS3Connection } from '../utils/s3Diagnostics';
import { useAuth } from './AuthContext';
interface MediaFile {
  id: string;
  file: File;
  preview: string;
  type: 'image' | 'video';
  caption: string;
  uploading: boolean;
  uploaded: boolean;
  error?: string;
  metadata?: MediaMetadata;
  compressed?: Blob;
  uploadProgress?: number;
  s3Url?: string;
  s3Key?: string;
}
interface MediaUploaderProps {
  onUploadComplete: (files: MediaFile[]) => void;
}
export function MediaUploader({
  onUploadComplete
}: MediaUploaderProps) {
  const { user } = useAuth();
  const [files, setFiles] = useState<MediaFile[]>([]);
  const [isDragging, setIsDragging] = useState(false);
  const [processing, setProcessing] = useState(false);
  const [useS3Upload, setUseS3Upload] = useState(true); // Toggle for S3 vs local storage
  const [s3TestResult, setS3TestResult] = useState<{ success: boolean; message: string } | null>(null);
  const [testingConnection, setTestingConnection] = useState(false);
  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    const droppedFiles = Array.from(e.dataTransfer.files);
    processFiles(droppedFiles);
  }, []);
  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const selectedFiles = Array.from(e.target.files);
      processFiles(selectedFiles);
    }
  };
  const processFiles = async (newFiles: File[]) => {
    setProcessing(true);
    const processedFiles: MediaFile[] = [];
    for (const file of newFiles) {
      const validation = validateFile(file);
      if (!validation.isValid) {
        // Add file with error
        processedFiles.push({
          id: Math.random().toString(36).substr(2, 9),
          file,
          preview: '',
          type: validation.fileType === 'image' ? 'image' : 'video',
          caption: '',
          uploading: false,
          uploaded: false,
          error: validation.error
        });
        continue;
      }
      if (validation.fileType !== 'image' && validation.fileType !== 'video') {
        continue;
      }
      try {
        // Extract metadata
        const metadata = await extractMetadata(file);
        // Generate thumbnail
        let thumbnail = '';
        let compressed: Blob | undefined;
        if (validation.fileType === 'image') {
          thumbnail = await generateImageThumbnail(file);
          // Compress image
          compressed = await compressImage(file);
        } else if (validation.fileType === 'video') {
          thumbnail = await generateVideoThumbnail(file);
        }
        processedFiles.push({
          id: Math.random().toString(36).substr(2, 9),
          file,
          preview: thumbnail || URL.createObjectURL(file),
          type: validation.fileType,
          caption: '',
          uploading: false,
          uploaded: false,
          metadata,
          compressed
        });
      } catch (error) {
        console.error('Error processing file:', error);
        processedFiles.push({
          id: Math.random().toString(36).substr(2, 9),
          file,
          preview: URL.createObjectURL(file),
          type: validation.fileType,
          caption: '',
          uploading: false,
          uploaded: false,
          error: 'Failed to process file'
        });
      }
    }
    setFiles(prev => [...prev, ...processedFiles]);
    setProcessing(false);
  };
  const removeFile = (id: string) => {
  const updateCaption = (id: string, caption: string) => {
    setFiles(prev => prev.map(f => f.id === id ? {
      ...f,
      caption
    } : f));
  };

  const testS3ConnectionHandler = async () => {
    setTestingConnection(true);
    setS3TestResult(null);
    
    try {
      const result = await testS3Connection();
      setS3TestResult({
        success: result.success,
        message: result.message
      });
    } catch (error) {
      setS3TestResult({
        success: false,
        message: error instanceof Error ? error.message : 'Connection test failed'
      });
    } finally {
      setTestingConnection(false);
    }
  };

  const uploadFiles = async () => {
    const validFiles = files.filter(f => !f.error);
    
    if (!user) {
      console.error('No user found for upload');
      return;
    }

    if (useS3Upload) {
      // Upload to S3
      for (let i = 0; i < validFiles.length; i++) {
        const fileData = validFiles[i];
        
        setFiles(prev => prev.map(f => 
          f.id === fileData.id ? { ...f, uploading: true, uploadProgress: 0 } : f
        ));

        try {
          // Use compressed version if available, otherwise original
          const fileToUpload = fileData.compressed || fileData.file;
          const fileName = fileData.file.name;

          const result = await uploadToS3(
            fileToUpload,
            fileName,
            {
              userId: user.email || user.name || 'guest',
              fileType: fileData.type,
              onProgress: (progress: UploadProgress) => {
                setFiles(prev => prev.map(f =>
                  f.id === fileData.id 
                    ? { ...f, uploadProgress: progress.percentage }
                    : f
                ));
              },
              metadata: {
                caption: fileData.caption,
                originalSize: fileData.file.size.toString(),
                compressed: fileData.compressed ? 'true' : 'false',
              }
            }
          );

          if (result.success && result.url) {
            setFiles(prev => prev.map(f =>
              f.id === fileData.id
                ? {
                    ...f,
                    uploading: false,
                    uploaded: true,
                    uploadProgress: 100,
                    s3Url: result.url,
                    s3Key: result.key,
                  }
                : f
            ));
          } else {
            setFiles(prev => prev.map(f =>
              f.id === fileData.id
                ? {
                    ...f,
                    uploading: false,
                    error: result.error || 'Upload failed',
                  }
                : f
            ));
          }
        } catch (error) {
          console.error('Upload error:', error);
          setFiles(prev => prev.map(f =>
            f.id === fileData.id
              ? {
                  ...f,
                  uploading: false,
                  error: error instanceof Error ? error.message : 'Upload failed',
                }
              : f
          ));
        }
      }
    } else {
      // Simulate local upload process with progress (original behavior)
      for (let i = 0; i < validFiles.length; i++) {
        setFiles(prev => prev.map(f => 
          f.id === validFiles[i].id ? { ...f, uploading: true } : f
        ));
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        setFiles(prev => prev.map(f =>
          f.id === validFiles[i].id
            ? { ...f, uploading: false, uploaded: true }
            : f
        ));
      }
    }

    setTimeout(() => {
      const uploadedFiles = files.filter(f => f.uploaded);
      onUploadComplete(uploadedFiles);
      setFiles([]);
    }, 500);
  };

  const validFilesCount = files.filter(f => !f.error).length;
  const hasErrors = files.some(f => f.error);

  return (
    <div className="space-y-6">
      {/* S3 Upload Toggle */}
      <div className="flex items-center justify-between p-4 bg-white/60 backdrop-blur-sm rounded-xl border border-white/50">
        <div className="flex items-center gap-3">
          <Cloud className={`w-5 h-5 ${useS3Upload ? 'text-[var(--sunset-orange)]' : 'text-gray-400'}`} />
          <div>
            <p className="font-serif text-sm text-gray-800 font-bold">
              AWS S3 Upload
            </p>
            <p className="text-xs text-gray-600 font-serif">
              {useS3Upload 
                ? 'Files will be uploaded to cloud storage' 
                : 'Files will be stored locally'}
            </p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          {useS3Upload && (
            <button
              onClick={testS3ConnectionHandler}
              disabled={testingConnection}
              className="px-3 py-1.5 text-xs font-serif rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors disabled:opacity-50"
            >
              {testingConnection ? 'Testing...' : 'Test Connection'}
            </button>
          )}
          <button
            onClick={() => setUseS3Upload(!useS3Upload)}
            className={`relative w-14 h-7 rounded-full transition-colors ${
              useS3Upload ? 'bg-[var(--sunset-orange)]' : 'bg-gray-300'
            }`}
          >
            <motion.div
              animate={{ x: useS3Upload ? 28 : 2 }}
              transition={{ type: 'spring', stiffness: 500, damping: 30 }}
              className="absolute top-1 w-5 h-5 bg-white rounded-full shadow-md"
            />
          </button>
        </div>
      </div>

      {/* S3 Connection Test Result */}
      {s3TestResult && (
        <motion.div
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className={`p-4 rounded-xl border ${
            s3TestResult.success
              ? 'bg-green-50 border-green-200'
              : 'bg-red-50 border-red-200'
          }`}
        >
          <div className="flex items-start gap-3">
            {s3TestResult.success ? (
              <Check className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
            ) : (
              <AlertTriangle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
            )}
            <div className="flex-1">
              <p className={`text-sm font-serif font-bold ${
                s3TestResult.success ? 'text-green-800' : 'text-red-800'
              }`}>
                {s3TestResult.success ? 'Connection Successful' : 'Connection Failed'}
              </p>
              <p className={`text-xs font-serif mt-1 ${
                s3TestResult.success ? 'text-green-700' : 'text-red-700'
              }`}>
                {s3TestResult.message}
              </p>
              {!s3TestResult.success && (
                <p className="text-xs font-serif mt-2 text-red-600">
                  Check browser console (F12) for detailed troubleshooting steps.
                </p>
              )}
            </div>
            <button
              onClick={() => setS3TestResult(null)}
              className="text-gray-400 hover:text-gray-600"
            >
              <X className="w-4 h-4" />
            </button>
          </div>
        </motion.div>
      )}

      {/* Drop Zone */}
      <motion.div 
        onDragOver={e => {
          e.preventDefault();
          setIsDragging(true);
        }} 
        onDragLeave={() => setIsDragging(false)} 
        onDrop={handleDrop} 
        className={`relative border-2 border-dashed rounded-2xl p-12 text-center transition-all ${isDragging ? 'border-[var(--sunset-orange)] bg-[var(--sunset-pink)]/20' : 'border-gray-300 bg-white/40'}`}
      >
        <input 
          type="file" 
          multiple 
          accept="image/*,video/*" 
          onChange={handleFileInput} 
          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
          disabled={processing} 
        />

        <motion.div 
          animate={isDragging ? { scale: 1.05 } : { scale: 1 }} 
          className="pointer-events-none"
        >
          {processing ? (
            <>
              <Loader className="w-16 h-16 text-[var(--sunset-orange)] mx-auto mb-4 animate-spin" />
              <h3 className="text-xl font-serif text-gray-800 mb-2">
                Processing files...
              </h3>
            </>
          ) : (
            <>
              <Upload className="w-16 h-16 text-[var(--sunset-orange)] mx-auto mb-4" />
              <h3 className="text-xl font-serif text-gray-800 mb-2">
                Drop photos and videos here
              </h3>
              <p className="text-gray-600 font-serif text-sm">
                or click to browse your files
              </p>
              <div className="flex items-center justify-center gap-4 mt-4 text-xs text-gray-500 font-serif">
                <span className="flex items-center gap-1">
                  <Image className="w-4 h-4" />
                  JPG, PNG, GIF, WebP (max 10MB)
                </span>
                <span className="flex items-center gap-1">
                  <Video className="w-4 h-4" />
                  MP4, MOV, AVI (max 100MB)
                </span>
              </div>
            </>
          )}
        </motion.div>
      </motion.div>

      {/* File List */}
      <AnimatePresence>
        {files.length > 0 && (
          <motion.div 
            initial={{ opacity: 0, height: 0 }} 
            animate={{ opacity: 1, height: 'auto' }} 
            exit={{ opacity: 0, height: 0 }} 
            className="space-y-4"
          >
            {files.map(file => (
              <motion.div 
                key={file.id} 
                initial={{ opacity: 0, x: -20 }} 
                animate={{ opacity: 1, x: 0 }} 
                exit={{ opacity: 0, x: 20 }} 
                className={`bg-white/60 backdrop-blur-sm rounded-xl p-4 border shadow-sm ${file.error ? 'border-red-300' : 'border-white/50'}`}
              >
                <div className="flex gap-4">
                  {/* Preview */}
                  <div className="flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden bg-gray-100">
                    {file.preview ? (
                      file.type === 'image' ? (
                        <img src={file.preview} alt="Preview" className="w-full h-full object-cover" />
                      ) : (
                        <video src={file.preview} className="w-full h-full object-cover" />
                      )
                    ) : (
                      <div className="w-full h-full flex items-center justify-center">
                        <AlertCircle className="w-8 h-8 text-red-400" />
                      </div>
                    )}
                  </div>

                  {/* Details */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex-1">
                        <p className="font-serif text-sm text-gray-800 truncate">
                          {file.file.name}
                        </p>
                        <div className="flex items-center gap-3 text-xs text-gray-500 font-serif mt-1">
                          <span>{formatFileSize(file.file.size)}</span>
                          {file.metadata?.width && file.metadata?.height && (
                            <span>
                              {file.metadata.width} Ã— {file.metadata.height}
                            </span>
                          )}
                          {file.metadata?.duration && (
                            <span>
                              {formatDuration(file.metadata.duration)}
                            </span>
                          )}
                          {file.compressed && (
                            <span className="text-green-600">
                              Compressed: {formatFileSize(file.compressed.size)}
                            </span>
                          )}
                        </div>
                      </div>
                      {!file.uploading && !file.uploaded && (
                        <button 
                          onClick={() => removeFile(file.id)} 
                          className="p-1 hover:bg-gray-100 rounded transition-colors"
                        >
                          <X className="w-4 h-4 text-gray-400" />
                        </button>
                      )}
                    </div>

                    {/* Error Message */}
                    {file.error && (
                      <div className="flex items-center gap-2 text-red-600 text-sm font-serif mb-2">
                        <AlertCircle className="w-4 h-4" />
                        {file.error}
                      </div>
                    )}

                    {/* Caption Input */}
                    {!file.uploaded && !file.error && (
                      <input 
                        type="text" 
                        value={file.caption} 
                        onChange={e => updateCaption(file.id, e.target.value)} 
                        placeholder="Add a caption or memory..." 
                        className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-[var(--sunset-orange)] focus:border-transparent outline-none font-serif" 
                      />
                    )}

                    {/* Status */}
                    {file.uploading && (
                      <div className="mt-2">
                        <div className="flex items-center justify-between text-sm text-[var(--sunset-orange)] font-serif mb-1">
                          <span className="flex items-center gap-2">
                            <Loader className="w-4 h-4 animate-spin" />
                            Uploading{useS3Upload && ' to S3'}...
                          </span>
                          {file.uploadProgress !== undefined && (
                            <span>{file.uploadProgress}%</span>
                          )}
                        </div>
                        {file.uploadProgress !== undefined && (
                          <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <motion.div
                              initial={{ width: 0 }}
                              animate={{ width: `${file.uploadProgress}%` }}
                              className="h-full bg-gradient-to-r from-[var(--sunset-orange)] to-[var(--sunset-coral)]"
                            />
                          </div>
                        )}
                      </div>
                    )}
                    {file.uploaded && (
                      <div className="flex items-center gap-2 mt-2">
                        <div className="flex items-center gap-2 text-green-600 text-sm font-serif">
                          <Check className="w-4 h-4" />
                          Uploaded{file.s3Url && ' to S3'}
                        </div>
                        {file.s3Url && (
                          <a
                            href={file.s3Url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-xs text-[var(--sunset-orange)] hover:underline font-serif"
                          >
                            View
                          </a>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </motion.div>
            ))}

            {/* Upload Button */}
            {validFilesCount > 0 && (
              <div className="space-y-3">
                {hasErrors && (
                  <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm font-serif">
                    Some files have errors and will be skipped.{' '}
                    {validFilesCount} file(s) ready to upload.
                  </div>
                )}
                <button 
                  onClick={uploadFiles} 
                  disabled={files.some(f => f.uploading || f.uploaded)} 
                  className="w-full py-3 bg-gradient-to-r from-[var(--sunset-orange)] to-[var(--sunset-coral)] text-white rounded-lg hover:shadow-lg transition-all font-serif disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Upload {validFilesCount}{' '}
                  {validFilesCount === 1 ? 'File' : 'Files'}
                </button>
              </div>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}